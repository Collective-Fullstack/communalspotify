{%extends "preactBase.html" %}
{%block title%}Room | Shareify{%endblock%}
{%block headerScripts%}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
{%endblock%}
{%block code %}

{{component_import("PaletteIndicator")}}

let socket = io.connect('http://' + document.domain + ':' + location.port);
socket.on('connect', function() {
    socket.emit('room_connect','{{roomcode}}');
});

class Player extends Component {
    constructor() {
        super();
        this.state = {
            playing:false,
            colourProfile: "DarkVibrant"
        } 
        
        console.log(this.state)
        
        _defineProperty(this, "getColours", (imgSRC) => {
            const colours = Vibrant.from(imgSRC)
                .getPalette()
                .then((palette) => palette)
            return colours
        })
        
        _defineProperty(this, "fetchData", (ev) => {
            fetch(`/api/getPlayState?roomcode=${roomCode}&uid=${uid}`)
              .then(r => r.json())
              .catch(() => {error:"fetching play state failed"})
              .then(data => this.setState({
                  spotifyData: data
              }))
              .then(()=> this.getColours(this.state.spotifyData.item.album.images[0].url))
              .then((palette) => this.setState({palette}))
              .then(()=>console.log(this.state))
              
        })
        
        _defineProperty(this, "playpause", (ev) => {
            socket.emit('playpause', '{{roomcode}}');
            console.log('sent playpause');
            ev.preventDefault();
            this.fetchData()
            this.setState({playing:!this.state.playing})
        })
        
        _defineProperty(this, "skip", (ev) => {
            socket.emit('skip', '{{roomcode}}');
            console.log('sent skip');
            setTimeout(() => {  this.fetchData() }, 1000);
        })
        
        _defineProperty(this, "getCSSPaletteVars", (profile="Vibrant", varName="page-bg") => {
            let currentPalette = this.state.palette[profile]._hsl ? 
            this.state.palette[profile]._hsl : 
            RGBtoHSL(this.state.palette[profile]._rgb[0], this.state.palette[profile]._rgb[1], this.state.palette[profile]._rgb[2])     
            
            return `
                --${varName}-h:${currentPalette[0]*360};
                --${varName}-s:${currentPalette[1]*100};
                --${varName}-l:${(currentPalette[2]*100)};
            `
        })
        
    }
     
    componentDidMount() {
        this.fetchData()
        this.timer = setInterval(() => {
              this.fetchData()
        }, 15000); // probably should make this check only a couple of times
    }
    componentWillUnmount() {
        // stop when not renderable
        clearInterval(this.timer);
      }
        
    render(){
        return(
            html`
            
            <style>
            :root{
                ${this.state.palette ? this.getCSSPaletteVars(this.state.colourProfile) : ''}
            }
            </style>
            <${PaletteIndicator} paletteStr=${this.state.palette ? JSON.stringify(this.state.palette) : false} profileInUse=${this.state.colourProfile} />
            <div class="px-2 sm:px-8">
                <div class="relative aspect-ratio-square rounded-lg">
                    <!--<img 
                        src="${this.state.spotifyData ? this.state.spotifyData.item.album.images[0].url : '' }"
                        class="rounded-lg absolute w-full h-full object-cover opacity-50"
                        style="filter: blur(20px)"
                    />-->
                    <img 
                        src="${this.state.spotifyData ? this.state.spotifyData.item.album.images[0].url : '' }"
                    
                        class="rounded-lg absolute w-full h-full object-cover shadow-xl bg-page-contrast"
                    />
                </div> 
            </div>
            <div class="flex justify-between px-3 sm:px-10 py-4">
            <button onClick=${this.playpause} class="underline">${this.state.playing? 'pause' : 'play'}</button>
            <div class="flex-grow text-center">
            ${this.state.spotifyData ? this.state.spotifyData.item.name : '...' } â€” ${this.state.spotifyData ? this.state.spotifyData.item.artists[0].name : '...'}
            </div>
            <button onClick=${this.skip} class="underline">skip</button>
            </div>
            
            `
        )
    }
}

const Room = () => {
    return html`
    <${SlotContent} name="headerNav">
        <div>
            Room Code: 
            <span class="bg-page-contrast text-page-bg px-1 ml-2">${roomCode}</span>
        </div>
    <//>
    <${Player}/>
    ` 
}

Main = () => (html`
    <${Room} />   
`) 

{%endblock%}